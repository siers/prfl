#! /usr/bin/env bash

flashListUpdate() {
  jq -R -n -c '[inputs]' <(find public/ -type f | sed 's:^public/::' | grep -v DS_Store) |
    sed 's/^/export default /; s:^:/* automatically generated, don'\''t touch */ :' \
      > src/programs/FlashList.js
}

deploy() {
  npm run build &&
    (
      cd /Users/raitisveinbahs/raitis/code/haskell/blag/perflab
      rsync -r --delete ~/raitis/code/js/perflab/dist/ /Users/raitisveinbahs/raitis/code/haskell/blag/perflab &&
        git add . &&
        git commit -am 'flash-command: deploy' &&
        git push --force-with-lease
    )
}

if ! pwd | grep -q perflab$; then
  return 1
fi

for v in "$@"; do
  if [ "$v" = "refresh" ]; then
    flashListUpdate
  fi

  if [ "$v" = "deploy" ]; then
    deploy
  fi
done
